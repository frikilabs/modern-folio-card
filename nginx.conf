# Nginx configuration for serving static React app built with Vite

server {
    listen 80;
    server_name _;

    # Root directory where Vite's dist folder is
    root /app/dist;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1000;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Index file
    index index.html;

    # Asset files (js, css, images, fonts)
    # These should be cached aggressively since they have content hashes
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header Access-Control-Allow-Origin "*";

        # Ensure correct MIME types
        types {
            text/javascript js;
            text/css css;
            image/svg+xml svg;
            font/woff2 woff2;
            font/woff woff;
        }
    }

    # HTML files - don't cache, always revalidate
    location ~* \.html?$ {
        expires -1;
        add_header Cache-Control "public, must-revalidate, proxy-revalidate";
    }

    # Root and API
    location / {
        # Try to serve the file directly
        try_files $uri $uri/ /index.html;

        # Cache control for index.html
        add_header Cache-Control "public, must-revalidate, proxy-revalidate";
    }

    # Deny access to sensitive files
    location ~ /\. {
        deny all;
    }

    location ~ ~$ {
        deny all;
    }
}
